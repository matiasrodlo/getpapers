{% extends "base.html" %} {% block content %}
<h1>Extract DOIs</h1>
<form id="extractForm">
  <label for="bibtex">BibTeX File:</label>
  <input type="text" id="bibtex" name="bibtex" value="{{ default_bibtex }}" />

  <label for="output">Output File:</label>
  <input type="text" id="output" name="output" value="{{ default_output }}" />

  <button type="submit">Start Extraction</button>
</form>

<!-- Progress Bar -->
<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>
<p id="progressCount">0/100</p>

<!-- Back Button -->
<div class="button-container" style="justify-content: center; margin-top: 20px">
  <a class="button" href="{{ url_for('index') }}">Back to Home</a>
</div>

<script>
  var currentLogFile = ""; // Store the unique log file name for this extraction

  function fetchProgress() {
    if (!currentLogFile) return;
    fetch("{{ url_for('progress') }}?log=" + currentLogFile)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("progressBar").style.width =
          data.progress + "%";
        document.getElementById("progressCount").textContent =
          data.count + "/" + data.total;
      });
  }

  // Poll progress every 2 seconds
  setInterval(fetchProgress, 2000);

  // Handle form submission using AJAX without pop-up
  document
    .getElementById("extractForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      let formData = new FormData(e.target);
      fetch("{{ url_for('start_extraction') }}", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data.status);
          // Store the unique log file name for progress polling
          currentLogFile = data.log_file;
        });
    });
</script>
{% endblock %}
