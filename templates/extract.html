{% extends "base.html" %} {% block content %}
<h1>Extract DOIs</h1>
<form id="extractForm">
  <label for="bibtex">BibTeX File:</label>
  <input type="text" id="bibtex" name="bibtex" value="{{ default_bibtex }}" />

  <label for="output">Output File:</label>
  <input type="text" id="output" name="output" value="{{ default_output }}" />

  <button type="submit" id="startExtractBtn">Start Extraction</button>
</form>

<!-- Progress message -->
<p id="extractingMessage" style="display: none; color: #555; margin-top: 10px">
  ‚è≥ Extraction in progress...
</p>

<!-- Summary Box -->
<div id="summary" class="summary-box" style="display: none">
  <h3>Extraction Summary</h3>
  <p id="total_extracted"></p>
  <p id="total_errors"></p>
  <ul id="failed_entries"></ul>
</div>

<!-- Back Button -->
<div class="button-container" style="justify-content: center; margin-top: 20px">
  <a class="button" href="{{ url_for('index') }}">Back to Home</a>
</div>

<script>
  let extractionStarted = false;

  function fetchSummary() {
    fetch("{{ url_for('extraction_summary') }}")
      .then((response) => response.json())
      .then((data) => {
        // Only show results if extraction was actually started
        if (!extractionStarted) return;

        if (data.total_extracted !== undefined) {
          document.getElementById("extractingMessage").style.display = "none";
          document.getElementById("summary").style.display = "block";
          document.getElementById("total_extracted").textContent =
            "Total DOIs Extracted: " + data.total_extracted;
          document.getElementById("total_errors").textContent =
            "Total Errors: " + data.total_errors;

          const ul = document.getElementById("failed_entries");
          ul.innerHTML = "";
          if (data.failed_entries && data.failed_entries.length > 0) {
            data.failed_entries.forEach((err) => {
              const li = document.createElement("li");
              li.textContent = err;
              ul.appendChild(li);
            });
          }
        }
      });
  }

  // Poll for summary updates every 5 seconds
  setInterval(fetchSummary, 5000);

  document
    .getElementById("extractForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      // UI feedback
      document.getElementById("startExtractBtn").style.display = "none";
      document.getElementById("extractingMessage").style.display = "block";
      extractionStarted = true;

      fetch("{{ url_for('start_extraction') }}", {
        method: "POST",
        body: formData,
      });
    });
</script>
{% endblock %}
